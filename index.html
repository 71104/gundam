<!DOCTYPE html>
<html>
<head>
	<title>Sonic The Hedgehog</title>
	<link rel="stylesheet" type="text/css" href="css/style.css"/>
	<script type="text/javascript" src="js/oogl-1.0.0.js"></script>
	<script type="text/javascript" src="js/QueryableDocument.js"></script>
</head>
<body>
	<canvas id="canvas">
		<p>No browser support, sorry.</p>
	</canvas>
	<script type="text/javascript">
function Mesh(oogl, arrays, indexArray) {
	this.draw = function () {
		arrays.bindAndPointer();
		indexArray.bind();
		indexArray.drawTriangles();
	};
}

function loadMesh(document, node, oogl) {
	function loadFloatArray(xpath) {
		return document.queryString(node, xpath).replace(/^\s+/, '').replace(/\s+$/, '').split(/\s+/).map(parseFloat);
	}

	function loadIntArray(xpath) {
		return document.queryString(node, xpath).replace(/^\s+/, '').replace(/\s+$/, '').split(/\s+/).map(function (string) {
			return parseInt(string, 10);
		});
	}

	debugger;

	var positions = loadFloatArray(
'./source[\
	concat(\"#\", @id) = ../vertices/input[\
		@semantic = \"POSITION\"\
	]/@source\
]/float_array[\
	concat(\"#\", @id) = ../technique_common/accessor[\
		@stride = \"3\"\
	]/@source\
]'
		);
	var textureCoordinates = loadFloatArray(
'./source[\
	concat(\"#\", @id) = ../polylist/input[\
		@semantic = \"TEXCOORD\"\
	]/@source\
]/float_array[\
	concat(\"#\", @id) = ../technique_common/accessor[\
		@stride = \"2\"\
	]/@source\
]'
		);
	var indices = (function () {
		var counts = loadIntArray('./polylist/vcount');
		var indices = loadIntArray('./polylist/p');
		var finalIndices = [];
		var i = 0;
		counts.forEach(function (count) {
			switch (count) {
			case 3:
				finalIndices.push(indices[i++]);
				finalIndices.push(indices[i++]);
				finalIndices.push(indices[i++]);
				break;
			case 4:
				finalIndices.push(indices[i++]);
				finalIndices.push(indices[i++]);
				finalIndices.push(indices[i]);
				finalIndices.push(indices[i++]);
				finalIndices.push(indices[i++]);
				finalIndices.push(indices[i - 4]);
				break;
			default:
				i += count;
				break;
			}
		});
		return finalIndices;
	})();

	var arrays = new oogl.AttributeArrays(positions.length / 3);
	arrays.add3f(positions);
	arrays.add2f(textureCoordinates);
	return new Mesh(oogl, arrays, new oogl.ElementArray(indices));
}

OOGL(function () {
	var canvas = document.getElementById('canvas');
	canvas.width = window.innerWidth;
	canvas.height = window.innerHeight;
	var oogl = new OOGL.Context(canvas, {
		alpha: false
	});
	oogl.clearColor(0, 0, 0, 1);
	oogl.clear(oogl.COLOR_BUFFER_BIT);
	oogl.flush();
	OOGL.Ajax.get('media/dae/gundam.dae', function (response) {
		var document = new QueryableDocument(response);
		var meshes = [];
		document.forEachNode('/COLLADA/library_geometries/geometry/mesh', function (node) {
			meshes.push(loadMesh(document, node, oogl));
		});
		var program = new oogl.AjaxProgram('glsl/gundam', ['in_Vertex', 'in_TexCoord'], function () {
			program.use();
			meshes.forEach(function (mesh) {
				mesh.draw();
			});
			oogl.flush();
		});
	}, 'document');
});
	</script>
</body>
</html>
